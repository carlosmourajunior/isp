version: '3.8'

# CONFIGURAÇÃO DE SEGURANÇA - SOBRESCREVE PORTAS EXPOSTAS
# Use: docker compose -f docker-compose.yml -f docker-compose.security.yml up

services:
  # ==================== SEGURANÇA DA BASE DE DADOS ====================
  db:
    ports: []  # REMOVE COMPLETAMENTE A EXPOSIÇÃO EXTERNA
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=P@ssw0rd_Secur3_2025!@#$%  # NOVA SENHA FORTE
    # Restrições de segurança adicionais
    security_opt:
      - no-new-privileges:true
    read_only: false  # Necessário para DB
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID

  # ==================== SEGURANÇA DO REDIS ====================
  redis:
    ports: []  # REMOVE EXPOSIÇÃO EXTERNA
    security_opt:
      - no-new-privileges:true
    read_only: false  # Necessário para Redis
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    cap_drop:
      - ALL

  # ==================== SEGURANÇA DA APLICAÇÃO ====================
  web:
    environment:
      # Atualiza string de conexão com nova senha
      - DATABASE_URL=postgresql://postgres:P@ssw0rd_Secur3_2025!@#$%@db:5432/postgres
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    cap_drop:
      - ALL
    # Expõe apenas na rede interna
    ports:
      - "127.0.0.1:8000:8000"  # APENAS LOCALHOST

  # ==================== SEGURANÇA DO MONITORAMENTO ====================
  prometheus:
    ports:
      - "127.0.0.1:9090:9090"  # APENAS LOCALHOST
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    cap_drop:
      - ALL

  grafana:
    ports:
      - "127.0.0.1:3000:3000"  # APENAS LOCALHOST
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    cap_drop:
      - ALL

  # ==================== SEGURANÇA DOS EXPORTERS ====================
  node-exporter:
    ports:
      - "127.0.0.1:9100:9100"  # APENAS LOCALHOST
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL

  redis-exporter:
    ports:
      - "127.0.0.1:9121:9121"  # APENAS LOCALHOST
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL

  postgres-exporter:
    ports:
      - "127.0.0.1:9187:9187"  # APENAS LOCALHOST
    environment:
      - DATA_SOURCE_NAME=postgresql://postgres:P@ssw0rd_Secur3_2025!@#$%@db:5432/postgres?sslmode=disable
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL

# ==================== REDE ISOLADA ====================
networks:
  app-network:
    driver: bridge
    internal: false  # Permite acesso à internet para updates
    ipam:
      config:
        - subnet: 172.20.0.0/16